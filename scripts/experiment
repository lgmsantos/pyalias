#! /usr/bin/env zsh

script_dir=$( dirname $( readlink -f $0 ) )
srcdir=$script_dir/../src/python
bindir=$script_dir/../bin
datadir=$script_dir/../data
numpydir=$script_dir/../../numpy/

export PYTHONPATH=$PYTHONPATH:$numpydir:$srcdir:$bindir

mkdir -p $datadir

DISTRIBUTION_SIZES=()
for i in $( seq 10 22 ); do
    DISTRIBUTION_SIZES=( $DISTRIBUTION_SIZES $(( 1 << i )) )
done

files=()

for ds in $DISTRIBUTION_SIZES; do 
    file_name=$( printf '%s/p%07d' $datadir $ds )
    files=( $files $file_name )
    if [[ ! -e $file_name ]]; then
        echo generating file $file_name
        python3 -m random_dist $ds $file_name
    fi
done


sample_size=$(( 1 << 23 - 1 ))
for i in $( seq 1 ${#files} ); do
    p_path=${files[i]}
    n=${DISTRIBUTION_SIZES[i]}
    result_file=$(dirname $p_path)/result-$(basename $p_path).csv
    tempfile=.temp

    echo running methods for file $( basename $p_path )
    echo $result_file
    if [[ ! -e $result_file ]]; then
        python3 -m choice header > $tempfile

        for method in {binsearch-old,binsearch-fixed,alias}; do
            echo '   ' $method
            time \
                python3 -m choice $method $p_path $sample_size >> $tempfile
        done

        echo done
        echo

        mv $tempfile $result_file
    fi
done

